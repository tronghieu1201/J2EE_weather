<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điều Khiển - Admin Panel</title>
    <link th:href="@{/css/tailwind.min.css(v=${cacheBuster})}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* Scale 75% như trang index */
        #page-wrapper {
            transform: scale(0.75);
            transform-origin: top left;
            width: calc(100% / 0.75);
            min-height: calc(100vh / 0.75);
            overflow-x: hidden;
            position: absolute;
            top: 0;
            left: 0;
        }

        body {
            min-height: calc(100vh / 0.75);
            overflow-y: auto;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.9);
        }

        .accuracy-ring {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(#10b981 var(--percent), #e2e8f0 0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .accuracy-ring::before {
            content: '';
            width: 75px;
            height: 75px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .dark .accuracy-ring::before {
            background: #1e293b;
        }

        .accuracy-ring span {
            position: relative;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
    <script th:src="@{/js/darkmode.js(v=${cacheBuster})}"></script>
</head>

<body
    class="bg-slate-100 dark:bg-[#0b1120] text-slate-800 dark:text-slate-200 font-sans min-h-screen transition-colors duration-300">

    <div id="page-wrapper">
        <!-- Header Admin -->
        <header class="sticky top-0 z-40 w-full glass shadow-sm border-b border-slate-200 dark:border-slate-700">
            <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                <!-- Logo & Title -->
                <div class="flex items-center gap-4">
                    <a th:href="@{/index}" class="flex items-center gap-3">
                        <img th:src="@{/img/z.png}" alt="Weather Icon" class="w-[60px] h-[48px]">
                        <div class="h-8 w-[1px] bg-slate-300 dark:bg-slate-600"></div>
                        <div>
                            <h1 class="text-lg font-bold text-slate-800 dark:text-white">Bảng Điều Khiển</h1>
                        </div>
                    </a>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex items-center gap-2">
                    <a th:href="@{/admin/dashboard(token=${token})}"
                        class="px-4 py-2 text-sm font-medium bg-primary/10 text-primary rounded-lg">
                        Bảng Điều Khiển
                    </a>
                    <a th:href="@{/admin/data-update(token=${token})}"
                        class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                        Update Data
                    </a>
                    <a th:href="@{/admin/alerts(token=${token})}"
                        class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                        Cảnh Báo
                        <span th:if="${alertCount > 0}"
                            class="ml-1 px-1.5 py-0.5 text-xs bg-red-500 text-white rounded-full"
                            th:text="${alertCount}"></span>
                    </a>
                </nav>

                <!-- Actions -->
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-500 dark:text-slate-400" id="currentTime"></span>
                    <button id="themeToggleBtn"
                        class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                        onclick="toggleTheme()">
                        <span id="themeIcon" class="material-symbols-outlined text-xl">dark_mode</span>
                    </button>
                    <a th:href="@{/index}"
                        class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary bg-slate-100 dark:bg-slate-800 rounded-lg transition-colors">
                        Trang Chủ
                    </a>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8 space-y-6">
            <!-- Success/Error Messages -->
            <div th:if="${successMessage}"
                class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 text-emerald-800 dark:text-emerald-300 px-6 py-4 rounded-xl flex items-center gap-3">
                <span class="material-symbols-outlined text-emerald-500">check_circle</span>
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}"
                class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 px-6 py-4 rounded-xl flex items-center gap-3">
                <span class="material-symbols-outlined text-red-500">error</span>
                <span th:text="${errorMessage}"></span>
            </div>

            <!-- Stats Cards - Giống update-data -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Tổng bản ghi -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl text-indigo-600 dark:text-indigo-400 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-2xl">database</span>
                            </div>
                        </div>
                        <h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Tổng số bản ghi</h3>
                        <div class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors"
                            th:text="${stats.totalRecords}">0</div>
                    </div>
                </div>

                <!-- Tỉnh có dữ liệu -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl text-emerald-600 dark:text-emerald-400 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-2xl">location_on</span>
                            </div>
                        </div>
                        <h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Tỉnh/Thành có dữ liệu
                        </h3>
                        <div
                            class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">
                            <span th:text="${stats.totalProvinces}">0</span>/63
                        </div>
                    </div>
                </div>

                <!-- Bản ghi 7 ngày -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="p-3 bg-cyan-50 dark:bg-cyan-900/20 rounded-xl text-cyan-600 dark:text-cyan-400 group-hover:bg-cyan-600 group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-2xl">calendar_month</span>
                            </div>
                        </div>
                        <h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Bản ghi 7 ngày</h3>
                        <div class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition-colors"
                            th:text="${stats.recordsLast7Days}">0</div>
                    </div>
                </div>

                <!-- Nhiệt độ TB Max -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-pink-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="p-3 bg-pink-50 dark:bg-pink-900/20 rounded-xl text-pink-600 dark:text-pink-400 group-hover:bg-pink-600 group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-2xl">thermostat</span>
                            </div>
                        </div>
                        <h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Nhiệt độ TB Max</h3>
                        <div
                            class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight group-hover:text-pink-600 dark:group-hover:text-pink-400 transition-colors">
                            <span th:text="${stats.avgMaxTemp}">0</span>°C
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Độ Chính Xác AI -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-green-500/10 rounded-bl-full -mr-6 -mt-6 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-6">
                            <div
                                class="p-2.5 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg">
                                <span class="material-symbols-outlined">target</span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Độ Chính Xác AI</h3>
                        </div>
                        <div class="flex justify-around mb-6">
                            <div class="text-center">
                                <div class="accuracy-ring mx-auto mb-2"
                                    th:style="'--percent: ' + ${accuracy.tempAccuracy} + '%'">
                                    <span class="text-slate-800 dark:text-white"
                                        th:text="${accuracy.tempAccuracy} + '%'">0%</span>
                                </div>
                                <span class="text-sm text-slate-500 dark:text-slate-400">Nhiệt độ</span>
                            </div>
                            <div class="text-center">
                                <div class="accuracy-ring mx-auto mb-2"
                                    th:style="'--percent: ' + ${accuracy.rainAccuracy} + '%'">
                                    <span class="text-slate-800 dark:text-white"
                                        th:text="${accuracy.rainAccuracy} + '%'">0%</span>
                                </div>
                                <span class="text-sm text-slate-500 dark:text-slate-400">Xác suất mưa</span>
                            </div>
                        </div>
                        <div
                            class="border-t border-slate-100 dark:border-slate-700 pt-4 flex justify-between items-center">
                            <span class="text-slate-600 dark:text-slate-400">Tổng thể:</span>
                            <span class="text-xl font-bold text-emerald-500"
                                th:text="${accuracy.overallAccuracy} + '%'">0%</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Dựa trên <span th:text="${accuracy.sampleSize}">0</span>
                            mẫu</p>
                    </div>
                </div>

                <!-- Auto-Schedule -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -mr-6 -mt-6 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-6">
                            <div
                                class="p-2.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg">
                                <span class="material-symbols-outlined">schedule</span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Auto-Schedule</h3>
                        </div>
                        <div class="bg-gradient-to-r from-slate-700 to-slate-800 rounded-xl p-4 mb-4">
                            <div class="flex items-center gap-2 text-white mb-1">
                                <span class="pulse w-2.5 h-2.5 bg-emerald-400 rounded-full"></span>
                                <span th:if="${schedulerEnabled}" class="font-medium">Đang hoạt động</span>
                                <span th:unless="${schedulerEnabled}" class="font-medium">Tắt</span>
                            </div>
                            <p class="text-sm text-slate-300">Thu thập tự động lúc 6:00 sáng mỗi ngày</p>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Lần chạy cuối:</span>
                                <div class="font-medium text-slate-800 dark:text-white" th:if="${lastCollectionTime}"
                                    th:text="${#temporals.format(lastCollectionTime, 'dd/MM/yyyy HH:mm')}">-</div>
                                <div class="font-medium text-slate-800 dark:text-white"
                                    th:unless="${lastCollectionTime}">Chưa chạy</div>
                            </div>
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Trạng thái:</span>
                                <div class="font-medium text-slate-800 dark:text-white"
                                    th:text="${lastCollectionStatus}">-</div>
                            </div>
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">Lần chạy tiếp:</span>
                                <div class="font-medium text-primary" th:text="${nextScheduledRun}">-</div>
                            </div>
                        </div>
                        <form th:action="@{/admin/scheduler/run-now}" method="post" class="mt-4">
                            <input type="hidden" name="token" th:value="${token}">
                            <button type="submit"
                                class="w-full py-3 bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl font-semibold hover:border-primary hover:text-primary transition-all">
                                Chạy ngay
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Cảnh Báo Đang Hoạt Động -->
                <div
                    class="relative group bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-orange-500/10 rounded-bl-full -mr-6 -mt-6 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2">
                                <div
                                    class="p-2.5 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg">
                                    <span class="material-symbols-outlined">notifications</span>
                                </div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Cảnh Báo Hoạt Động</h3>
                            </div>
                            <a th:href="@{/admin/alerts(token=${token})}"
                                class="text-sm text-primary hover:underline font-medium">Quản lý</a>
                        </div>
                        <div th:if="${#lists.isEmpty(activeAlerts)}" class="text-center py-8 text-slate-400">
                            <span class="material-symbols-outlined text-4xl mb-2 text-emerald-400">check_circle</span>
                            <p class="font-medium">Không có cảnh báo</p>
                        </div>
                        <div th:unless="${#lists.isEmpty(activeAlerts)}" class="space-y-3 max-h-48 overflow-y-auto">
                            <div th:each="alert : ${activeAlerts}"
                                class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border-l-4"
                                th:classappend="'border-' + ${alert.severityColor}">
                                <div class="font-medium text-slate-800 dark:text-white" th:text="${alert.title}">Alert
                                </div>
                                <div class="text-xs text-slate-500 mt-1" th:text="${alert.alertType}">Type</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Top Tỉnh/Thành -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex items-center gap-2">
                        <div class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg">
                            <span class="material-symbols-outlined">bar_chart</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 dark:text-white">Top Tỉnh/Thành</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead
                                class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-3 text-left">#</th>
                                    <th class="px-6 py-3 text-left">Tỉnh/Thành</th>
                                    <th class="px-6 py-3 text-center">Số bản ghi</th>
                                    <th class="px-6 py-3 text-right">Ngày mới nhất</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                <tr th:each="p, stat : ${topProvinces}"
                                    class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                    <td class="px-6 py-3 text-slate-500" th:text="${stat.index + 1}">1</td>
                                    <td class="px-6 py-3 font-medium text-slate-800 dark:text-white"
                                        th:text="${p.province}">Province</td>
                                    <td class="px-6 py-3 text-center">
                                        <span
                                            class="px-2.5 py-1 bg-primary/10 text-primary text-xs font-bold rounded-full"
                                            th:text="${p.recordCount}">0</span>
                                    </td>
                                    <td class="px-6 py-3 text-right text-slate-500"
                                        th:text="${p.latestDate != null ? #temporals.format(p.latestDate, 'dd/MM/yyyy') : '-'}">
                                        -</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trạng Thái Hệ Thống -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex items-center gap-2">
                        <div
                            class="p-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-lg">
                            <span class="material-symbols-outlined">settings</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 dark:text-white">Trạng Thái Hệ Thống</h3>
                    </div>
                    <div class="p-6 grid grid-cols-2 gap-4">
                        <div
                            class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-600">
                            <span class="material-symbols-outlined text-2xl text-emerald-500">database</span>
                            <div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Database</div>
                                <div class="font-bold text-emerald-600 dark:text-emerald-400">Kết nối OK</div>
                            </div>
                        </div>
                        <div
                            class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-600">
                            <span class="material-symbols-outlined text-2xl text-primary">memory</span>
                            <div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Model AI</div>
                                <div class="font-bold text-primary" th:text="${systemStatus.modelStatus}">Active</div>
                            </div>
                        </div>
                        <div
                            class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-600">
                            <span class="material-symbols-outlined text-2xl"
                                th:classappend="${systemStatus.dataUpToDate} ? 'text-emerald-500' : 'text-amber-500'">sync</span>
                            <div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Dữ liệu</div>
                                <div class="font-bold"
                                    th:classappend="${systemStatus.dataUpToDate} ? 'text-emerald-600 dark:text-emerald-400' : 'text-amber-600 dark:text-amber-400'"
                                    th:text="${systemStatus.dataUpToDate} ? 'Cập nhật' : 'Cần cập nhật'">Status</div>
                            </div>
                        </div>
                        <div
                            class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-600">
                            <span class="material-symbols-outlined text-2xl text-cyan-500">percent</span>
                            <div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Coverage</div>
                                <div class="font-bold text-cyan-600 dark:text-cyan-400"
                                    th:text="${stats.coveragePercent} + '%'">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleDateString('vi-VN') + ' ' + now.toLocaleTimeString('vi-VN');
        }
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>

</html>