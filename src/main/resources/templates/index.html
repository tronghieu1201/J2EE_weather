<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dự báo thời tiết AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        @media (min-width: 992px) {
            .navbar-expand-lg .navbar-nav .dropdown:hover .dropdown-menu {
                display: block;
            }
            .megamenu {
                padding: 1rem;
                left: 50%;
                transform: translateX(-50%);
                width: 100vw;
            }
            .megamenu .dropdown-header {
                text-transform: uppercase;
                font-size: 0.8em;
                color: #5a6c7d;
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        body {
            background: linear-gradient(180deg, #e8f4f8 0%, #f0f8ff 100%) !important;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Navbar */
        .navbar {
            background: white !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 1rem 0;
        }

        .navbar .container-fluid {
            max-width: 1320px;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .navbar-brand {
            color: #5eb3d6 !important;
        }

        .navbar-brand:hover {
            color: #4a9ec4 !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5eb3d6 0%, #4a9ec4 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4a9ec4 0%, #3d8bb0 100%);
        }

        @media (max-width: 1399px) {
            .navbar .container-fluid {
                max-width: 1140px;
            }
        }

        @media (max-width: 1199px) {
            .navbar .container-fluid {
                max-width: 960px;
            }
        }

        @media (max-width: 991px) {
            .navbar .container-fluid {
                max-width: 720px;
            }
        }

        @media (max-width: 767px) {
            .navbar .container-fluid {
                max-width: 540px;
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Main container */
        .weather-container {
            max-width: 1320px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem;
        }

        @media (max-width: 1399px) {
            .weather-container {
                max-width: 1140px;
            }
        }

        @media (max-width: 1199px) {
            .weather-container {
                max-width: 960px;
            }
        }

        @media (max-width: 991px) {
            .weather-container {
                max-width: 720px;
            }
        }

        @media (max-width: 767px) {
            .weather-container {
                max-width: 540px;
                padding: 1.5rem 1rem;
            }
        }

        /* Left card - Current weather */
        .current-weather-card {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        @media (max-width: 991px) {
            .current-weather-card {
                position: relative;
                top: 0;
                margin-bottom: 2rem;
            }
        }

        .city-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .city-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .city-time {
            font-size: 0.875rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        .status-badge {
            background: linear-gradient(135deg, #5eb3d6 0%, #4a9ec4 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .weather-main {
            text-align: center;
            padding: 2rem 0;
        }

        .weather-icon-large {
            font-size: 120px;
            color: #5eb3d6;
            margin-bottom: 1rem;
        }

        .temp-display {
            font-size: 4.5rem;
            font-weight: 700;
            color: #2d3748;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .weather-desc {
            font-size: 1.125rem;
            color: #4a5568;
            margin-bottom: 0.25rem;
        }

        .feels-like {
            font-size: 0.875rem;
            color: #a0aec0;
        }

        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 575px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        .metric-item {
            background: #f8fafb;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid #e8eef2;
        }

        .metric-item i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #5eb3d6;
        }

        .metric-value {
            display: block;
            font-size: 1.125rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #718096;
        }

        /* Weather tip */
        .weather-tip {
            background: linear-gradient(135deg, #5eb3d6 0%, #4a9ec4 100%);
            border-radius: 16px;
            padding: 1.5rem;
            color: white;
            margin-top: 1.5rem;
        }

        .weather-tip h5 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .weather-tip p {
            font-size: 0.875rem;
            margin: 0;
            opacity: 0.95;
        }

        /* Right section */
        .forecast-section {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        @media (max-width: 767px) {
            .forecast-section {
                padding: 1.5rem;
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .view-details {
            color: #5eb3d6;
            font-size: 0.875rem;
            text-decoration: none;
        }

        .view-details:hover {
            color: #4a9ec4;
        }

        /* 7-day forecast */
        .forecast-scroll {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 0.5rem 0 1rem 0;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
            margin: 0 -0.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .forecast-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .forecast-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .forecast-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .forecast-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .forecast-day {
            background: #fafcfd;
            border: 1px solid #e8eef2;
            border-radius: 16px;
            padding: 1.5rem 1.25rem;
            min-width: 130px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
            display: block;
            flex-shrink: 0;
        }

        @media (max-width: 575px) {
            .forecast-day {
                min-width: 110px;
                padding: 1.25rem 1rem;
            }
        }

        .forecast-day:hover {
            background: #f0f7fa;
            border-color: #5eb3d6;
            box-shadow: 0 2px 8px rgba(94, 179, 214, 0.15);
        }

        .forecast-day.active {
            background: linear-gradient(135deg, #5eb3d6 0%, #4a9ec4 100%);
            border-color: #5eb3d6;
            color: white;
        }

        .forecast-day.active .day-name,
        .forecast-day.active .day-date,
        .forecast-day.active .temp-range,
        .forecast-day.active .rain-prob {
            color: white;
        }

        .day-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .day-date {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-bottom: 1rem;
        }

        .forecast-icon {
            font-size: 2.5rem;
            margin: 0.75rem 0;
            color: #5eb3d6;
        }

        .forecast-day.active .forecast-icon {
            color: white;
        }

        .temp-range {
            font-size: 0.875rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0.75rem 0 0.5rem;
        }

        .rain-prob {
            font-size: 0.75rem;
            color: #5eb3d6;
        }

        /* Sun times */
        .sun-times {
            display: flex;
            justify-content: space-around;
            padding: 1rem 0;
        }

        .sun-time-item {
            text-align: center;
        }

        .sun-icon {
            font-size: 3rem;
            color: #f59e0b;
            margin-bottom: 0.5rem;
        }

        .sun-label {
            font-size: 0.875rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }

        .sun-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2d3748;
        }

        /* Air quality */
        .aqi-display {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .aqi-number {
            font-size: 3.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .aqi-info {
            flex: 1;
        }

        .aqi-badge {
            background: linear-gradient(135deg, #5eb3d6 0%, #4a9ec4 100%);
            color: white;
            padding: 0.375rem 0.875rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .aqi-bar {
            height: 6px;
            background: #e8eef2;
            border-radius: 3px;
            overflow: hidden;
        }

        .aqi-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #5eb3d6, #4a9ec4);
            border-radius: 3px;
        }

        /* Pollutants grid */
        .pollutants-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 575px) {
            .pollutants-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .pollutant-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafb;
            border-radius: 12px;
            border: 1px solid #e8eef2;
        }

        .pollutant-item i {
            font-size: 1.25rem;
            color: #5eb3d6;
            margin-bottom: 0.5rem;
        }

        .pollutant-label {
            font-size: 0.75rem;
            color: #a0aec0;
            display: block;
            margin-bottom: 0.25rem;
        }

        .pollutant-value {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }

        /* Alert styling */
        .alert {
            border-radius: 12px;
            border: 1px solid #e8eef2;
        }

        /* Spinner */
        .spinner-border {
            color: #5eb3d6 !important;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">
            <i class="bi bi-cloud-sun me-2"></i>WeatherAI
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown">
                        Tỉnh/Thành phố
                    </a>
                    <div class="dropdown-menu megamenu" aria-labelledby="navbarDropdownMenuLink">
                        <div class="container">
                            <div class="row">
                                <th:block th:each="entry : ${groupedCities}">
                                    <div class="col-md-3">
                                        <h6 class="dropdown-header" th:text="${entry.key}"></h6>
                                        <a th:each="province : ${entry.value}" href="#" th:onclick="fetchWeatherData('[(${province})]');" class="dropdown-item" th:text="${province}"></a>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/chart">Biểu đồ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/perpetual-calendar">Xem lịch vạn niên</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="weatherNewsDropdown" role="button" data-bs-toggle="dropdown">
                        Tin thời tiết
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="weatherNewsDropdown">
                        <li><a class="dropdown-item" href="/weather-news/daily">Tin tức hằng ngày</a></li>
                        <li><a class="dropdown-item" href="/weather-news/travel">Thời tiết du lịch</a></li>
                        <li><a class="dropdown-item" href="/weather-news/nature">Thiên nhiên</a></li>
                    </ul>
                </li>
            </ul>
            <div class="d-flex align-items-center">
                <form th:action="@{/}" method="post" class="input-group" style="max-width: 300px;">
                    <span class="input-group-text border-0 bg-light"><i class="bi bi-search text-muted"></i></span>
                    <input class="form-control border-0 bg-light" type="search" name="city" placeholder="Nhập tên thành phố...">
                    <button class="btn btn-primary" type="submit">Tìm kiếm</button>
                </form>
                <i class="bi bi-moon fs-5 ms-3 cursor-pointer text-muted"></i>
            </div>
        </div>
    </div>
</nav>

<main id="weatherDisplayArea" th:fragment="weatherContent">
    <div class="weather-container">
        <!-- Error message -->
        <div th:if="${comprehensiveReport == null or sevenDayForecast == null or #lists.isEmpty(sevenDayForecast)}" class="alert alert-warning text-center" role="alert">
            <p th:if="${city != null}">Không thể tải dữ liệu thời tiết cho <strong><span th:text="${city}"></span></strong>. Vui lòng thử lại.</p>
            <p th:if="${city == null}">Vui lòng nhập tên thành phố để xem dự báo thời tiết.</p>
        </div>

        <div class="row" th:if="${comprehensiveReport != null and sevenDayForecast != null and not #lists.isEmpty(sevenDayForecast)}">
            <!-- Left: Current Weather -->
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="current-weather-card">
                    <div class="city-header">
                        <div>
                            <h1 class="city-name" th:text="${city}">Hà Nội</h1>
                            <p class="city-time">Hôm nay, <span th:text="${#temporals.format(T(java.time.OffsetDateTime).now(), 'HH:mm')}">12:00</span> PM</p>
                        </div>
                        <span class="status-badge">
                            <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Cập nhật
                        </span>
                    </div>

                    <div th:with="current=${comprehensiveReport.current}, hourly=${comprehensiveReport.hourly}">
                        <div class="weather-main">
                            <i class="weather-icon-large bi"
                               th:classappend="${T(com.weather.forecast.util.WeatherIconMapper).getIconClass(current.weatherCode)}"></i>
                            <div class="temp-display" th:text="${#numbers.formatDecimal(current.temperature, 0, 0)} + '°C'">22°C</div>
                            <p class="weather-desc" th:text="${T(com.weather.forecast.util.WeatherCodeMapper).getDescription(current.weatherCode)}">Mưa rào nhẹ</p>
                            <p class="feels-like" th:text="'Cảm giác như ' + ${#numbers.formatDecimal(current.apparentTemperature, 0, 0)} + '°C'">Cảm giác như 20°C</p>
                        </div>

                        <div class="metrics-grid">
                            <div class="metric-item">
                                <i class="bi bi-droplet-fill"></i>
                                <span class="metric-value" th:text="${current.humidity} + '%'">84%</span>
                                <span class="metric-label">ĐỘ ẨM</span>
                            </div>
                            <div class="metric-item">
                                <i class="bi bi-speedometer2"></i>
                                <span class="metric-value" th:text="${#numbers.formatDecimal(current.surfacePressure, 0, 0)} + ' hPa'">1014 hPa</span>
                                <span class="metric-label">ÁP SUẤT</span>
                            </div>
                            <div class="metric-item">
                                <i class="bi bi-wind"></i>
                                <span class="metric-value" th:text="${#numbers.formatDecimal(current.windSpeed, 1, 1)} + ' km/h'">2,4 km/h</span>
                                <span class="metric-label">TỐC ĐỘ GIÓ</span>
                            </div>
                            <!-- Assuming visibility is available in hourly data and taking the first value -->
                            <div class="metric-item" th:if="${hourly != null and not #lists.isEmpty(hourly.visibility)}">
                                <i class="bi bi-eye-fill"></i>
                                <span class="metric-value" th:text="${#numbers.formatDecimal(hourly.visibility.get(0) / 1000, 1, 1)} + ' km'">24,1 km</span>
                                <span class="metric-label">TẦM NHÌN</span>
                            </div>
                             <!-- This was the UV Index metric item. It has been removed as requested. -->
                        </div>
                    </div>
                </div>

                <div class="weather-tip" th:with="code=${comprehensiveReport.current.weatherCode}">
                    <h5><i class="bi bi-lightbulb me-2"></i>Mẹo thời tiết</h5>
                    <p th:if="${code >= 51 and code <= 67 or code >= 80 and code <= 82}">Trời có mưa, bạn nhớ mang theo ô hoặc áo mưa khi ra ngoài.</p>
                    <p th:if="${code >= 45 and code <= 48}">Có sương mù, hãy cẩn thận khi lái xe.</p>
                    <p th:if="${code >= 71 and code <= 77 or code >= 85 and code <= 86}">Trời có tuyết! Giữ ấm và tận hưởng nhé.</p>
                    <p th:if="${code <= 3}">Thời tiết đẹp, một ngày tuyệt vời cho các hoạt động ngoài trời.</p>
                </div>
            </div>

            <!-- Right: Forecasts -->
            <div class="col-lg-8 col-md-12">
                <!-- 7-day forecast -->
                <div class="forecast-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="bi bi-calendar3 me-2"></i>Dự báo 7 ngày tiếp theo</h2>
                    </div>
                    <div class="forecast-scroll">
                        <!--/* Loop through the 7-day forecast data */-->
                        <a th:each="forecast, iterStat : ${sevenDayForecast}"
                           th:href="@{/hourly-details(city=${city}, date=${forecast.date})}"
                           class="forecast-day"
                           th:classappend="${iterStat.index == 0} ? 'active' : ''">

                            <div class="day-name" th:text="${iterStat.index == 0} ? 'Hôm nay' : ${#temporals.format(forecast.date, 'E', 'vi')}"></div>
                            <div class="day-date" th:text="${#temporals.format(forecast.date, 'dd/MM')}"></div>

                            <i class="forecast-icon bi"
                               th:classappend="${T(com.weather.forecast.util.WeatherIconMapper).getIconClass(forecast.weatherCode)}"></i>

                            <div class="temp-range">
                                <span th:text="${#numbers.formatDecimal(forecast.tempMax, 0, 0)} + '°'"></span> /
                                <span style="opacity: 0.7;" th:text="${#numbers.formatDecimal(forecast.tempMin, 0, 0)} + '°'"></span>
                            </div>

                            <div class="rain-prob">
                                <i class="bi bi-droplet-fill"></i>
                                <span th:text="${#numbers.formatDecimal(forecast.rainProbability * 100, 0, 0)} + '%'"></span>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Sun times -->
                <div class="forecast-section">
                    <h2 class="section-title"><i class="bi bi-brightness-high me-2"></i>Mặt trời mọc & lặn</h2>
                    <div class="sun-times">
                        <div class="sun-time-item">
                            <i class="bi bi-sunrise sun-icon"></i>
                            <p class="sun-label">Mọc</p>
                            <p class="sun-value">06:15 AM</p>
                        </div>
                        <div class="sun-time-item">
                            <i class="bi bi-sunset sun-icon"></i>
                            <p class="sun-label">Lặn</p>
                            <p class="sun-value">05:45 PM</p>
                        </div>
                    </div>
                </div>

                <!-- Air quality -->
                <div class="forecast-section">
                    <h2 class="section-title"><i class="bi bi-wind me-2"></i>Chất lượng không khí</h2>
                    <div class="aqi-display">
                        <div class="aqi-number">32</div>
                        <div class="aqi-info">
                            <span class="aqi-badge">Tốt</span>
                            <div class="aqi-bar">
                                <div class="aqi-bar-fill" style="width: 32%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pollutants-grid">
                        <div class="pollutant-item">
                            <i class="bi bi-mask"></i>
                            <span class="pollutant-label">PM2.5:</span>
                            <span class="pollutant-value">12</span>
                        </div>
                        <div class="pollutant-item">
                            <i class="bi bi-mask"></i>
                            <span class="pollutant-label">PM10:</span>
                            <span class="pollutant-value">18</span>
                        </div>
                        <div class="pollutant-item">
                            <i class="bi bi-cloud-sun"></i>
                            <span class="pollutant-label">O3:</span>
                            <span class="pollutant-value">24</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    async function fetchWeatherData(city) {
        const weatherDisplayArea = document.getElementById('weatherDisplayArea');
        if (weatherDisplayArea) {
            weatherDisplayArea.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Đang tải...</span></div><p class="mt-3">Đang tải dữ liệu thời tiết cho ' + city + '...</p></div>';
            try {
                const response = await fetch(`/get-weather-fragment?city=${encodeURIComponent(city)}`);
                if (response.ok) {
                    const htmlFragment = await response.text();
                    weatherDisplayArea.innerHTML = htmlFragment;
                } else {
                    weatherDisplayArea.innerHTML = '<div class="alert alert-danger text-center" role="alert">Không thể tải dữ liệu thời tiết cho ' + city + '. Vui lòng thử lại.</div>';
                    console.error('Failed to fetch weather fragment:', response.statusText);
                }
            } catch (error) {
                weatherDisplayArea.innerHTML = '<div class="alert alert-danger text-center" role="alert">Có lỗi xảy ra khi tải dữ liệu thời tiết.</div>';
                console.error('Error fetching weather data:', error);
            }
        }
    }
</script>

</body>