<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dự báo thời tiết AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
            color: #333;
        }
        .header-bar {
            background-color: #343a40;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-bar .form-control {
            max-width: 300px;
        }
        .main-content-wrapper {
            padding: 2rem 0;
        }
        .weather-display-grid {
            display: grid;
            grid-template-columns: 1fr; /* Single column by default */
            gap: 2rem;
        }
        @media (min-width: 992px) { /* Medium devices and up */
            .weather-display-grid {
                grid-template-columns: 1.5fr 1fr; /* Two columns: current weather wide, daily forecast narrower */
            }
        }

        .current-weather-card {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .current-weather-main-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1.5rem;
        }
        .current-weather-main-info .temp {
            font-size: 4rem;
            font-weight: 500;
        }
        .weather-icon-large { font-size: 4rem; color: #007bff; }
        .current-weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }
        .detail-item {
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
        }
        .detail-item .label {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .detail-item .value {
            font-weight: bold;
        }

        .daily-forecast-container {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 1rem; /* Padding to prevent shadow clipping */
            border-radius: 0.5rem;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .daily-forecast-card {
            flex: 0 0 140px; /* Fixed width for each card */
            padding: 1.5rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.75rem;
            text-align: center;
            background-color: #ffffff;
        }
        .daily-forecast-card .day-name { font-weight: bold; }
        .daily-forecast-card .date-small { color: #6c757d; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .daily-forecast-card .icon { font-size: 2.5rem; margin: 0.5rem 0; color: #007bff;}
        .daily-forecast-card .temp-range { font-weight: bold; margin-bottom: 0.5rem; }
        .daily-forecast-card .rain-prob { font-size: 0.85rem; color: #6c757d; }
    </style>
</head>
<body>
<main class="main-content-wrapper">
    <div class="container">
        <!-- Error / No data message -->
        <div th:if="${comprehensiveReport == null or sevenDayForecast == null or #lists.isEmpty(sevenDayForecast)}" class="alert alert-warning text-center" role="alert">
            <p th:if="${city != null}">Không thể tải dữ liệu thời tiết cho <strong><span th:text="${city}"></span></strong>. Vui lòng thử lại với một thành phố khác hoặc đảm bảo kết nối internet.</p>
            <p th:if="${city == null}">Vui lòng nhập tên thành phố để xem dự báo thời tiết.</p>
        </div>

        <!-- Main Weather Display (Conditional on data being present) -->
        <div th:if="${comprehensiveReport != null and sevenDayForecast != null and not #lists.isEmpty(sevenDayForecast)}" class="weather-display-grid">
            <!-- Current Weather Panel (from ComprehensiveReport) -->
            <div class="current-weather-card">
                <h2 class="mb-4" th:text="'Thời tiết hiện tại tại ' + ${city}"></h2>
                <div class="current-weather-main-info">
                    <i class="weather-icon-large" th:classappend="${T(com.weather.forecast.util.WeatherIconMapper).getIconClass(comprehensiveReport.current.weatherCode)}"></i>
                    <div>
                        <div class="temp" th:text="${#numbers.formatDecimal(comprehensiveReport.current.temperature, 0, 0)} + '°C'"></div>
                        <div th:text="${T(com.weather.forecast.util.WeatherCodeMapper).getDescription(comprehensiveReport.current.weatherCode)}"></div>
                        <div class="text-muted" th:text="'Cảm giác như ' + ${#numbers.formatDecimal(comprehensiveReport.current.apparentTemperature, 0, 0)} + '°C'"></div>
                    </div>
                </div>

                <div class="current-weather-details">
                    <div class="detail-item">
                        <div class="label">Độ ẩm</div>
                        <div class="value" th:text="${comprehensiveReport.current.humidity} + '%'"></div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Áp suất</div>
                        <div class="value" th:text="${#numbers.formatDecimal(comprehensiveReport.current.surfacePressure, 0, 0)} + ' hPa'"></div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Tốc độ gió</div>
                        <div class="value" th:text="${#numbers.formatDecimal(comprehensiveReport.current.windSpeed, 1, 1)} + ' km/h'"></div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Tầm nhìn</div>
                        <div class="value" th:text="${#numbers.formatDecimal(comprehensiveReport.hourly.visibility[0] / 1000, 1, 1)} + ' km'"></div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Chỉ số UV</div>
                        <div class="value" th:text="${#numbers.formatDecimal(comprehensiveReport.hourly.uvIndex[0], 0, 0)}"></div>
                    </div>
                </div>
            </div>

            <!-- 7-Day AI Forecast Cards -->
            <div>
                <h3 class="mb-3">Dự báo 7 ngày tới (AI)</h3>
                <div class="daily-forecast-container">
                    <div th:each="forecastDay, stat : ${sevenDayForecast}" class="daily-forecast-card">
                        <div class="day-name" th:text="${stat.index == 0 ? 'Hôm nay' : 'T' + #temporals.format(forecastDay.date, 'E')}"></div>
                        <div class="date-small" th:text="${#temporals.format(forecastDay.date, 'dd/MM')}"></div>
                        <div class="icon">
                            <i th:classappend="${T(com.weather.forecast.util.WeatherIconMapper).getIconClass(T(com.weather.forecast.util.WeatherCodeMapper).mapRainProbToWeatherCode(forecastDay.rainProbability))}"></i>
                        </div>
                        <div class="temp-range" th:text="${#numbers.formatDecimal(forecastDay.tempMax, 0, 0)} + '°C / ' + ${#numbers.formatDecimal(forecastDay.tempMin, 0, 0)} + '°C'"></div>
                        <div class="rain-prob">
                            <i class="bi bi-umbrella-fill"></i>
                            <span th:text="${#numbers.formatDecimal(forecastDay.rainProbability * 100, 0, 0)} + '%'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
</body>
</html>